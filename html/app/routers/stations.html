<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>app.routers.stations API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>app.routers.stations</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from fastapi import Depends, APIRouter, HTTPException
from fastapi.security import HTTPBasic, HTTPBasicCredentials
import secrets

from uuid import UUID

from ..models.Station import Station
from ..requests import StationRequest
from ..lib.reporter import Bridge, StationReporter

security = HTTPBasic()

router = APIRouter(
    prefix=&#34;/stations&#34;,
    tags=[&#34;Stations&#34;],
    dependencies=[Depends(StationRequest.Schema), Depends(Station)]
)

# --------------------------
# All stations operations
# --------------------------

@router.get(&#34;/&#34;)
def read_stations(credentials: HTTPBasicCredentials = Depends(security)):
  &#34;&#34;&#34;Get all stations

  Returns:
     Station: Gets all the stations available in the system
  &#34;&#34;&#34;
  stations = Station.all()

  # Include each station incidents and solved incidents
  for station in stations:
    station.incidents = station.events.serialize()
    # station.solved_incidents = station.events(all=True).serialize()

  return {
      &#34;stations&#34;: stations.serialize()
  }

# -------------------------
# Single station operations
# -------------------------


@router.get(&#34;/{uuid}&#34;)
def get_station(uuid: str):
  &#34;&#34;&#34;
  Get a specific station from it&#39;s uuid
  &#34;&#34;&#34;
  result = Station.find(uuid)
  result.incidents = result.events.serialize()

  return result.serialize()


@router.put(&#34;/&#34;)
async def put_station(station: StationRequest.Schema):
  &#34;&#34;&#34; Creates a station with all the information provided from the Station.Schema

  First, tries to connecto to the station using the credentials provided, then tries to register it,
  and then tries to store it in the database.
  &#34;&#34;&#34;
  # TODO: Generate a XML according to the Schema http://cecatev.uacj.mx/Estaciones.xml after the request

  # Checks if the driver exists on the drivers from the Bridge
  if not Bridge.driver_exists(station.driver):
    raise HTTPException(status_code=400, detail=&#34;Driver not found&#34;)

  stationModel = Station()

  stationModel.name = station.name
  stationModel.ip = station.ip
  stationModel.port = station.port
  stationModel.username = station.username
  stationModel.driver = station.driver
  stationModel.has_key = False

  # Create a instance of the driver
  instance = Bridge.get_driver_instance(stationModel)

  # # Get the available services according to the driver
  stationModel.services = instance.get_services()

  # Tries to get the status of the station (if it is online)
  try:
    status = instance.get_status()
  except:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to connect to the station&#34;)

  # Use the instance of the driver to register the station
  try:
    instance.register(station)
    stationModel.has_key = True
  except Exception as e:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to register the station, error: {}&#34;.format(e))

  # Store the station in the database
  try:
    stationModel.save()
  except:
    raise HTTPException(status_code=500, detail=&#34;Unable to save the station&#34;)

  return {
      &#34;status&#34;: &#34;Ok&#34;,
      &#34;model&#34;: stationModel.serialize()
  }


@router.delete(&#34;/{uuid}&#34;)
def delete_station(uuid: UUID):
  &#34;&#34;&#34;
  Delete a station based on the station uuid

  This actually *soft deletes* the station, to preserve the history of the station
  &#34;&#34;&#34;
  station = Station.get(uuid)
  station.delete()
  return {&#34;message&#34;: &#34;station deleted&#34;}


@router.post(&#34;/{uuid}&#34;)
def post_station(uuid: str, station: StationRequest.Schema):
  &#34;&#34;&#34;
  Updates a specific station with the information provided from the StationRequest.Schema
  &#34;&#34;&#34;
  station = Station.get(uuid=uuid)
  station.update(**station.dict())
  return station.serialize()

@router.post(&#34;/{uuid}/rescan&#34;)
def rescan_station(uuid: str):
  &#34;&#34;&#34;
  Loads the staion data from the dabase, then instantiates the driver and forces a rescan with the StationReporter
  &#34;&#34;&#34;
  station = Station.get(uuid=uuid)
  station.rescan()
  
  return station.serialize()

@router.post(&#34;/{uuid}/solve&#34;)
def solve_incident(uuid: str, incident_path: str):
  &#34;&#34;&#34;
  Solves an incident for a specific station
  &#34;&#34;&#34;
  station = Station.find(uuid)

  # Create a instance of the driver
  reporter = StationReporter(station)

  # Tries to solve the incident
  try:
    status = reporter.fix_event(incident_path)
  except Exception as e:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to connect to the station&#34;)

  return status</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="app.routers.stations.delete_station"><code class="name flex">
<span>def <span class="ident">delete_station</span></span>(<span>uuid: uuid.UUID)</span>
</code></dt>
<dd>
<div class="desc"><p>Delete a station based on the station uuid</p>
<p>This actually <em>soft deletes</em> the station, to preserve the history of the station</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.delete(&#34;/{uuid}&#34;)
def delete_station(uuid: UUID):
  &#34;&#34;&#34;
  Delete a station based on the station uuid

  This actually *soft deletes* the station, to preserve the history of the station
  &#34;&#34;&#34;
  station = Station.get(uuid)
  station.delete()
  return {&#34;message&#34;: &#34;station deleted&#34;}</code></pre>
</details>
</dd>
<dt id="app.routers.stations.get_station"><code class="name flex">
<span>def <span class="ident">get_station</span></span>(<span>uuid: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Get a specific station from it's uuid</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.get(&#34;/{uuid}&#34;)
def get_station(uuid: str):
  &#34;&#34;&#34;
  Get a specific station from it&#39;s uuid
  &#34;&#34;&#34;
  result = Station.find(uuid)
  result.incidents = result.events.serialize()

  return result.serialize()</code></pre>
</details>
</dd>
<dt id="app.routers.stations.post_station"><code class="name flex">
<span>def <span class="ident">post_station</span></span>(<span>uuid: str, station: <a title="app.requests.StationRequest.Schema" href="../requests/StationRequest.html#app.requests.StationRequest.Schema">Schema</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>Updates a specific station with the information provided from the StationRequest.Schema</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.post(&#34;/{uuid}&#34;)
def post_station(uuid: str, station: StationRequest.Schema):
  &#34;&#34;&#34;
  Updates a specific station with the information provided from the StationRequest.Schema
  &#34;&#34;&#34;
  station = Station.get(uuid=uuid)
  station.update(**station.dict())
  return station.serialize()</code></pre>
</details>
</dd>
<dt id="app.routers.stations.put_station"><code class="name flex">
<span>async def <span class="ident">put_station</span></span>(<span>station: <a title="app.requests.StationRequest.Schema" href="../requests/StationRequest.html#app.requests.StationRequest.Schema">Schema</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a station with all the information provided from the Station.Schema</p>
<p>First, tries to connecto to the station using the credentials provided, then tries to register it,
and then tries to store it in the database.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.put(&#34;/&#34;)
async def put_station(station: StationRequest.Schema):
  &#34;&#34;&#34; Creates a station with all the information provided from the Station.Schema

  First, tries to connecto to the station using the credentials provided, then tries to register it,
  and then tries to store it in the database.
  &#34;&#34;&#34;
  # TODO: Generate a XML according to the Schema http://cecatev.uacj.mx/Estaciones.xml after the request

  # Checks if the driver exists on the drivers from the Bridge
  if not Bridge.driver_exists(station.driver):
    raise HTTPException(status_code=400, detail=&#34;Driver not found&#34;)

  stationModel = Station()

  stationModel.name = station.name
  stationModel.ip = station.ip
  stationModel.port = station.port
  stationModel.username = station.username
  stationModel.driver = station.driver
  stationModel.has_key = False

  # Create a instance of the driver
  instance = Bridge.get_driver_instance(stationModel)

  # # Get the available services according to the driver
  stationModel.services = instance.get_services()

  # Tries to get the status of the station (if it is online)
  try:
    status = instance.get_status()
  except:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to connect to the station&#34;)

  # Use the instance of the driver to register the station
  try:
    instance.register(station)
    stationModel.has_key = True
  except Exception as e:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to register the station, error: {}&#34;.format(e))

  # Store the station in the database
  try:
    stationModel.save()
  except:
    raise HTTPException(status_code=500, detail=&#34;Unable to save the station&#34;)

  return {
      &#34;status&#34;: &#34;Ok&#34;,
      &#34;model&#34;: stationModel.serialize()
  }</code></pre>
</details>
</dd>
<dt id="app.routers.stations.read_stations"><code class="name flex">
<span>def <span class="ident">read_stations</span></span>(<span>credentials: fastapi.security.http.HTTPBasicCredentials = Depends(HTTPBasic))</span>
</code></dt>
<dd>
<div class="desc"><p>Get all stations</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Station</code></dt>
<dd>Gets all the stations available in the system</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.get(&#34;/&#34;)
def read_stations(credentials: HTTPBasicCredentials = Depends(security)):
  &#34;&#34;&#34;Get all stations

  Returns:
     Station: Gets all the stations available in the system
  &#34;&#34;&#34;
  stations = Station.all()

  # Include each station incidents and solved incidents
  for station in stations:
    station.incidents = station.events.serialize()
    # station.solved_incidents = station.events(all=True).serialize()

  return {
      &#34;stations&#34;: stations.serialize()
  }</code></pre>
</details>
</dd>
<dt id="app.routers.stations.rescan_station"><code class="name flex">
<span>def <span class="ident">rescan_station</span></span>(<span>uuid: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Loads the staion data from the dabase, then instantiates the driver and forces a rescan with the StationReporter</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.post(&#34;/{uuid}/rescan&#34;)
def rescan_station(uuid: str):
  &#34;&#34;&#34;
  Loads the staion data from the dabase, then instantiates the driver and forces a rescan with the StationReporter
  &#34;&#34;&#34;
  station = Station.get(uuid=uuid)
  station.rescan()
  
  return station.serialize()</code></pre>
</details>
</dd>
<dt id="app.routers.stations.solve_incident"><code class="name flex">
<span>def <span class="ident">solve_incident</span></span>(<span>uuid: str, incident_path: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Solves an incident for a specific station</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@router.post(&#34;/{uuid}/solve&#34;)
def solve_incident(uuid: str, incident_path: str):
  &#34;&#34;&#34;
  Solves an incident for a specific station
  &#34;&#34;&#34;
  station = Station.find(uuid)

  # Create a instance of the driver
  reporter = StationReporter(station)

  # Tries to solve the incident
  try:
    status = reporter.fix_event(incident_path)
  except Exception as e:
    raise HTTPException(
        status_code=422, detail=&#34;Unable to connect to the station&#34;)

  return status</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="app.routers" href="index.html">app.routers</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="app.routers.stations.delete_station" href="#app.routers.stations.delete_station">delete_station</a></code></li>
<li><code><a title="app.routers.stations.get_station" href="#app.routers.stations.get_station">get_station</a></code></li>
<li><code><a title="app.routers.stations.post_station" href="#app.routers.stations.post_station">post_station</a></code></li>
<li><code><a title="app.routers.stations.put_station" href="#app.routers.stations.put_station">put_station</a></code></li>
<li><code><a title="app.routers.stations.read_stations" href="#app.routers.stations.read_stations">read_stations</a></code></li>
<li><code><a title="app.routers.stations.rescan_station" href="#app.routers.stations.rescan_station">rescan_station</a></code></li>
<li><code><a title="app.routers.stations.solve_incident" href="#app.routers.stations.solve_incident">solve_incident</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>